<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Security — Тёмная тема + VirusTotal</title>
<style>
:root{
  --bg:#0b0f13;
  --card:#0f1418;
  --muted:#9aa5b1;
  --accent:#3dd6ff;
  --safe:#0b8a4a;
  --warn:#b88600;
  --danger:#d64545;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#050608, #0c1116);color:#e6eef2;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px;}
.app{width:100%;max-width:1100px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.logo{
  background:linear-gradient(135deg,var(--accent),#6be3ff);
  width:56px;height:56px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.6);
  display:flex;align-items:center;justify-content:center;font-weight:700;color:#021017;font-size:20px;
  transform:translateZ(0);
}
.title{font-size:20px;font-weight:700}
.subtitle{color:var(--muted);font-size:13px;margin-top:4px}

/* layout */
.grid{display:grid;grid-template-columns: 420px 1fr; gap:20px;align-items:start}
@media(max-width:920px){ .grid{grid-template-columns:1fr} .video-wrap{order:-1} }

/* camera/card */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:14px;border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,0.6); }
.video-wrap video{width:100%;height:auto;border-radius:10px;border:2px solid rgba(255,255,255,0.04);background:#010204}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .18s ease}
.btn.primary{background:linear-gradient(90deg,var(--accent),#72e6ff);color:#021017;border:none}
.btn:active{transform:translateY(1px)}
.inputfile{display:none}

/* result */
.result{margin-top:12px;padding:12px;border-radius:10px;display:none;transform-origin:top center;animation:pop .25s ease both}
@keyframes pop{from{opacity:0; transform:scale(.98) translateY(6px)} to{opacity:1; transform:scale(1) translateY(0)}}
.result .url{display:block;word-break:break-all;margin-top:8px;color:#dff9ff;text-decoration:underline}
.result .meta{margin-top:6px;color:var(--muted);font-size:13px}

/* result status */
.result.safe{background:linear-gradient(90deg, rgba(11,138,74,0.12), rgba(11,138,74,0.06)); border:1px solid rgba(11,138,74,0.2); box-shadow:0 6px 18px rgba(11,138,74,0.05)}
.result.warn{background:linear-gradient(90deg, rgba(184,134,0,0.12), rgba(184,134,0,0.06)); border:1px solid rgba(184,134,0,0.2)}
.result.danger{background:linear-gradient(90deg, rgba(214,69,69,0.12), rgba(214,69,69,0.06)); border:1px solid rgba(214,69,69,0.2)}

/* history */
.history{margin-top:16px; max-height:360px; overflow:auto;padding:12px;border-radius:10px;background:var(--glass); border:1px solid rgba(255,255,255,0.02)}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;transition:background .12s}
.hist-item:hover{background:rgba(255,255,255,0.012)}
.hist-left{max-width:70%}
.hist-url{font-size:14px;color:#dfefff;word-break:break-all}
.hist-meta{font-size:12px;color:var(--muted)}
.tag{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
.tag.safe{background:rgba(11,138,74,0.14); color:var(--safe)}
.tag.warn{background:rgba(184,134,0,0.12); color:var(--warn)}
.tag.danger{background:rgba(214,69,69,0.12); color:var(--danger)}

/* subtle animations */
.fade-in{animation:fadeIn .28s ease both}
@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

/* small helpers */
.small{font-size:13px;color:var(--muted)}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">QR</div>
    <div>
      <div class="title">QR Security — тёмная тема & VirusTotal</div>
      <div class="subtitle">Сканирование: камера / файл / буфер. История и автоматическая проверка через VirusTotal (через прокси).</div>
    </div>
  </div>

  <div class="grid">
    <!-- left: camera + controls -->
    <div class="card video-wrap">
      <video id="camera" autoplay muted playsinline></video>
      <div class="controls">
        <button id="btnToggle" class="btn primary">Включить камеру</button>
        <button id="btnStop" class="btn">Остановить</button>
        <label class="btn"><input id="fileInput" class="inputfile" type="file" accept="image/*">Загрузить изображение</label>
        <button id="btnPaste" class="btn">Вставить из буфера</button>
        <button id="btnSample" class="btn">Тестовый QR</button>
      </div>
      <div id="camStatus" class="small" style="margin-top:8px">Камера выключена</div>
      <div id="resultBox" class="result" role="status" aria-live="polite"></div>
    </div>

    <!-- right: history and settings -->
    <div>
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>История проверок</strong><div class="small">Локально в браузере</div></div>
          <div><button id="clearHistory" class="btn">Очистить</button></div>
        </div>
        <div id="history" class="history fade-in"></div>
      </div>

      <div class="card">
        <strong>Информация о VirusTotal</strong>
        <p class="small" style="margin-top:8px">Для проверки через VirusTotal нужно развернуть небольшую серверную прокси и положить туда API-ключ (ENV <code>VIRUSTOTAL_API_KEY</code>). Сервер делает запросы к API и возвращает результат фронтенду — таким образом ключ остаётся секретным.</p>
        <p class="small"><b>Примечание:</b> VirusTotal имеет лимиты по запросам; используй экономно (для демонстрации олимпиадного проекта — достаточно нескольких запросов).</p>
        <div style="margin-top:12px"><button id="btnVTinfo" class="btn">Проверить VirusTotal (текущая ссылка)</button></div>
      </div>
    </div>
  </div>

  <div class="footer">Проект для олимпиады по Информационной безопасности — готовый фронтенд + сервер</div>
</div>

<canvas id="canvas" hidden></canvas>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
(async function(){
  // элементы
  const video = document.getElementById('camera');
  const btnToggle = document.getElementById('btnToggle');
  const btnStop = document.getElementById('btnStop');
  const fileInput = document.getElementById('fileInput');
  const btnPaste = document.getElementById('btnPaste');
  const btnSample = document.getElementById('btnSample');
  const resultBox = document.getElementById('resultBox');
  const historyEl = document.getElementById('history');
  const camStatus = document.getElementById('camStatus');
  const btnVTinfo = document.getElementById('btnVTinfo');
  const clearHistoryBtn = document.getElementById('clearHistory');

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let stream = null, scanning = false, rafId = null;

  // ---------- history ----------
  function loadHistory(){ return JSON.parse(localStorage.getItem('qr-history') || '[]'); }
  function saveHistory(arr){ localStorage.setItem('qr-history', JSON.stringify(arr)); }
  function addHistory(url,status,meta){
    const h = loadHistory();
    h.unshift({url,status,time:new Date().toLocaleString(), meta});
    if(h.length>200) h.length = 200;
    saveHistory(h);
    renderHistory();
  }
  function clearHistory(){ localStorage.removeItem('qr-history'); renderHistory(); }
  clearHistoryBtn.onclick = clearHistory;

  function renderHistory(){
    const h = loadHistory();
    if(!h.length){ historyEl.innerHTML = '<div class="small">История пуста</div>'; return; }
    historyEl.innerHTML = h.map(item=>{
      const tag = item.status === 'SAFE' ? 'safe' : (item.status==='DANGER'?'danger':'warn');
      return `
        <div class="hist-item">
          <div class="hist-left">
            <div class="hist-url">${escapeHtml(item.url)}</div>
            <div class="hist-meta">${item.time} ${item.meta? ' · '+escapeHtml(item.meta):''}</div>
          </div>
          <div><div class="tag ${tag}">${item.status}</div></div>
        </div>
      `;
    }).join('');
  }
  renderHistory();

  // ---------- utils ----------
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function isSafeScheme(raw){
    try{ const u = new URL(raw); return (u.protocol==='http:'||u.protocol==='https:'); }catch(e){ return false; }
  }

  // ---------- QR decode ----------
  function scanFrame(){
    if(!scanning) return;
    if(video.readyState >= 2 && video.videoWidth && video.videoHeight){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      try{
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if(code && code.data) handleDecoded(code.data);
      }catch(e){
        // ignore getImageData errors on some browsers/devices
      }
    }
    rafId = requestAnimationFrame(scanFrame);
  }

  function decodeFromImage(img){
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
    try{
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if(code && code.data) handleDecoded(code.data);
      else showMessage('QR-код не найден на изображении', 'warn');
    }catch(e){ showMessage('Ошибка обработки изображения: '+e.message, 'warn'); }
  }

  // ---------- display ----------
  function showMessage(text, status='warn', url=null, meta=''){
    resultBox.style.display = 'block';
    resultBox.className = 'result ' + (status==='SAFE'?'safe':(status==='DANGER'?'danger':'warn'));
    let inner = `<div><strong>${escapeHtml(text)}</strong></div>`;
    if(url){
      inner += `<a class="url" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
      inner += `<div class="meta">${escapeHtml(meta||'')}</div>`;
      inner += `<div style="margin-top:8px"><button id="openNow" class="btn primary">Открыть (если безопасно)</button> <button id="copyNow" class="btn">Копировать</button> <button id="vtCheck" class="btn">Проверить VirusTotal</button></div>`;
    }
    resultBox.innerHTML = inner;
    // attach handlers if url
    setTimeout(()=>{
      const openNow = document.getElementById('openNow');
      const copyNow = document.getElementById('copyNow');
      const vtCheck = document.getElementById('vtCheck');
      if(openNow) openNow.onclick = () => { if(status==='DANGER'){ alert('Открытие заблокировано: ссылка признана опасной'); return; } window.open(url,'_blank','noopener'); }
      if(copyNow) copyNow.onclick = async () => { try { await navigator.clipboard.writeText(url); alert('Скопировано'); } catch(e){ alert('Ошибка копирования: '+e); } };
      if(vtCheck) vtCheck.onclick = () => callVirusTotal(url);
    },50);
  }

  // ---------- analysis logic (local heuristics) ----------
  function localAnalyze(url){
    const lower = String(url).toLowerCase();
    let score = 0;
    const risky = ['login','verify','confirm','secure','account','update','free','gift','bonus','prize'];
    risky.forEach(w => { if(lower.includes(w)) score += 2; });
    if(!lower.startsWith('https://')) score += 3;
    if(url.length > 140) score += 2;
    if(url.includes('@')) score += 4;
    try{
      const host = (new URL(url)).hostname;
      if(host.length > 40) score += 2;
      if((host.match(/-/g)||[]).length > 3) score += 2;
    }catch(e){ score += 2; }
    return score;
  }

  // ---------- Phishing lists (simple fetch) ----------
  async function checkPhishingLists(url){
    try{
      const host = (new URL(url)).hostname;
      // tiny caches to reduce repeated fetches
      if(!window._phishCache){
        window._phishCache = {};
      }
      const lists = [
        'https://openphish.com/feed.txt',
        // alternative csv/list (some CORS may block; server-side preferred)
        'https://phishstats.info/phish_score.csv'
      ];
      for(const list of lists){
        try{
          // simple cache by list URL
          if(!window._phishCache[list]){
            const res = await fetch(list);
            if(!res.ok) { window._phishCache[list] = ''; continue; }
            window._phishCache[list] = await res.text();
          }
          if(window._phishCache[list].includes(host)) return true;
        }catch(e){
          // ignore CORS/fetch errors (some lists block direct fetch)
        }
      }
    }catch(e){}
    return false;
  }

  // ---------- handle decoded QR ----------
  let lastHandled = null;
  async function handleDecoded(raw){
    if(lastHandled === raw) return; // simple dedupe
    lastHandled = raw;
    if(!isSafeScheme(raw)){
      showMessage('QR содержит небезопасную схему (не http/https)', 'DANGER', raw, 'Схема не поддерживается');
      addHistory(raw,'DANGER','Небезопасная схема');
      return;
    }

    // local heuristics
    const score = localAnalyze(raw);
    const localStatus = score <= 2 ? 'SAFE' : (score <= 6 ? 'WARN' : 'DANGER');
    showMessage(localStatus === 'SAFE' ? 'Ссылка локально признана безопасной' : (localStatus==='WARN'?'Ссылка вызывает подозрение':'Опасная ссылка'), localStatus, raw, 'Локальная оценка: '+score);

    // add to history (we'll later update with VT result if available)
    addHistory(raw, localStatus, 'Локальная оценка: '+score);

    // also check open phishing lists (best-effort)
    const inLists = await checkPhishingLists(raw);
    if(inLists){
      showMessage('Домен найден в публичных фишинговых списках','DANGER',raw,'Найден в открытых списках');
      addHistory(raw,'DANGER','Найден в открыт. списках');
    }

    // optionally kick off VirusTotal check in background (non-blocking)
    // if server available, do it
    try{ callVirusTotal(raw, true); }catch(e){}
  }

  // ---------- Camera control ----------
  btnToggle.onclick = async () => {
    if(scanning){ return; }
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      camStatus.textContent = 'Камера активна — наведите на QR';
      rafId = requestAnimationFrame(scanFrame);
      btnToggle.textContent = 'Камера включена';
    }catch(e){
      camStatus.textContent = 'Ошибка камеры: ' + e.message;
      alert('Не удалось включить камеру: ' + e.message);
    }
  };
  btnStop.onclick = () => {
    scanning = false;
    if(rafId) cancelAnimationFrame(rafId);
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    video.srcObject = null;
    camStatus.textContent = 'Камера остановлена';
    btnToggle.textContent = 'Включить камеру';
  };

  // ---------- File input ----------
  fileInput.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const img = new Image();
    img.onload = ()=> decodeFromImage(img);
    img.onerror = ()=> alert('Не удалось прочитать изображение');
    img.src = URL.createObjectURL(f);
  };

  // ---------- Paste from clipboard ----------
  btnPaste.onclick = async ()=>{
    try{
      // requires "clipboard-read" permission in some browsers
      const items = await navigator.clipboard.read();
      for(const item of items){
        for(const type of item.types){
          if(type.startsWith('image/')){
            const blob = await item.getType(type);
            const img = new Image();
            img.onload = ()=> decodeFromImage(img);
            img.src = URL.createObjectURL(blob);
            return;
          }
        }
      }
      alert('В буфере нет изображения (поддерживается только изображение).');
    }catch(e){
      // some browsers deny navigator.clipboard.read; fallback: try paste event
      alert('Невозможно прочитать буфер: ' + (e && e.message ? e.message : 'доступ запрещён'));
    }
  };

  // ---------- sample btn ----------
  btnSample.onclick = ()=> {
    const samples = [
      'https://example.com/welcome',
      'http://free-gift.example.com/login',
      'https://secure-bank.example.com/verify-account',
      'javascript:alert(1)'
    ];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    handleDecoded(pick);
  };

  // ---------- VirusTotal integration ----------
  //  - frontend calls POST /vt/scan { url } on same origin
  //  - server returns { status: 'ok'|'error', vt: { summary... } }
  async function callVirusTotal(url, background=false){
    // check that server endpoint exists
    try{
      const res = await fetch('/vt/scan', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ url })
      });
      if(!res.ok){
        if(!background) alert('Ошибка связи с сервером VirusTotal: ' + res.status);
        return;
      }
      const data = await res.json();
      if(data.error){
        if(!background) alert('VirusTotal: ' + data.error);
        return;
      }
      // data.vtSummary expected (summary object)
      const summary = data.vtSummary || {};
      const positives = summary.positives || 0;
      // show result (override local status if dangerous)
      let status = 'SAFE';
      if(positives > 0) status = 'DANGER';
      else if(summary.suspicious) status = 'WARN';
      // update display and history
      showMessage(`VirusTotal: ${positives} детекций`, status, url, 'VT: '+(summary.engine_count||0)+' движков');
      addHistory(url, status, 'VirusTotal: ' + positives + ' детекций');
    }catch(e){
      if(!background) alert('Ошибка при вызове VirusTotal: ' + e.message);
    }
  }

  // quick VT info button (uses last URL in history or notify)
  btnVTinfo.onclick = ()=>{
    const h = loadHistory();
    if(!h.length){ alert('Нет URL в истории для проверки'); return; }
    const last = h[0].url;
    callVirusTotal(last,false);
  };

  // expose simple manual decode for testing (e.g., from server returned image)
  window._debugDecodeFromURL = (imgUrl) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=> decodeFromImage(img);
    img.src = imgUrl;
  };

})();
</script>
</body>
</html>
